# 목표
- 어떠한 준비도 되어있지 않은 방금 설치한 linux system에 대하여
- HaplotypeCaller만 돌릴 수 있는 환경을 구성해본다.
# 준비된 환경
1. Rocky Linux 9
	- Docker를 활용하여 windows11 환경에서 구축
2. 서버를 다루기 편하도록 Docker와 Visual Studio Code를 서로 연결
	- VSCode의 Docker 확장프로그램을 통하여 연결
	- Docker 내의 Rocky Linux 9에서 터미널 열기
		- Docker Window의 bash 혹은 VSCode에서 attach to bash로 접속하면 cluster system에 접속할 때 처럼 bash가 뜬다. (`sh-5.1#`)
		- Docker에서 Rocky Linux 9이 깔린 컨테이너를 실행한 다음, VSCode에서 해당 컨테이어와 터미널을 연결시키면 새 창에서 접속하게 된다.
# 1. 자주 사용하는 기본적인 패키지, 라이브러리 설치
## 기본상식: yum? dnf? apt? sudo?
- `yum`과 `apt`는 모두 패키지 설치 관리자다. 다만 같은 리눅스 계열이라 할지라도 어느 리눅스 시스템을 쓰느냐에 따라 다른 패키지 설치 관리자를 사용하게 된다.
- `yum`은 Rocky Linux 9와 같은 '레드헷 리눅스(RHEL)' 계열의 리눅스 시스템의 패키지 설치 관리자이다.
	- RHEL에는 대표적으로 Centos 시리즈가 잘 알려져있다.
- `dnf`는 RHEL 계열 중에서도 버전 8 이상부터 지원하는 패키지 설치 관리자이다. `yum`을 사용하는 방식과 똑같이 사용할 수 있다. 다만 상대적으로 RHEL8 이상 버전이 아직 널리 쓰이지 않아서 많은 인터넷의 팁들이 `yum`으로 명령어를 소개하고 있다. Rocky Linux의 경우 RHEL9 계열이므로 당연히 dnf로도 설치가 가능하다.
- `apt` 패키지 설치 관리자는 Ubuntu에서 사용되는 패키지 설치 관리자다.
	-  RHEL계열에서 기본적으로는 사용되지 않는다.
- `sudo`는 패키지의 한 종류로, 비밀번호만 알고 있다면 일반 사용자도 관리자 권한으로 명령어를 수행할 수 있게 해준다. 리눅스 시스템 계열과 상관없이 사용할 수 있지만, Rocky Linux에는 기본적으로 설치가 되어있지 않 패키지라 직접 설치해줘야한다.
# 기본적으로 다운받은 패키지들
모든 명령어는 일반사용자가 아닌 root 사용자로 로그인한 상태에서 진행하였다.

**which**  `yum install which`

**python** `yum install python`

**pip** `yum install pip`

**wget** `pip install wget`

**sudo** `yum install sudo`

**vim** `yum install vim`

**unzip** `yum install unzip`

# 2. GATK부터 설치
## GATK를 다운받자
- 간단하게 파일만 받아서 설치하자.
	- 파일을 다운 받는다: [GATK github /release](https://github.com/broadinstitute/gatk/releases)
	- `unzip gatk-4.4.0.0.zip`
- 위와 같은 간단한 방법 말고도, Anaconda로 받거나, 공식 github에서 clone으로 받거나, docker image로 받거나 여러 방법이 있다. [참고: Getting started with GATK4](https://gatk.broadinstitute.org/hc/en-us/articles/360036194592-Getting-started-with-GATK4)
	- 그러나 이런 방법들은 다시 추가적인 환경 구축을 요구한다 -> 귀찮다
- 대신 수동설치는 최신버전을 받기 위해서 주기적으로 수동설치를 요구한다는 단점 아닌 단점이 있다.
	- 파이프라인의 안정성 유지와 최신 버전을 통한 성능향상은 모두 중요하다.
	- 최신 버전이 항상 더 나은 퍼포먼스를 약속하지 않으며, 예상치 못한 버그를 일으킬 수 있다.
## GATK를 위한 필수프로그램들을 다운받자
[GATK requirements](https://github.com/broadinstitute/gatk#requirements)
- 필수 프로그램들은 run/build 목적에 따라 다르게 소개된다. 이번에는 run만을 위한 프로그램만 설치한다.
1. 특정 버전의 JAVA
	- 4.4.0.0 버전의 경우 OpenJDK 17 버전을 요구하고 있다.
	- 향후에 요구사항이 바뀔 수 있으니 설치 전에 항상 requirement 부분을 잘 읽어보자
	- [install openjdk17 on centos RHEL 7](https://computingforgeeks.com/install-java-openjdk-17-on-centos-rhel-7/?expand_article=1)
	- `wget https://download.oracle.com/java/17/latest/jdk-17_linux-x64_bin.rpm`
	- `yum -y install ./jdk-17_linux-x64_bin.rpm`
	- 버전확인도 수행하자
		```shell
		# java --version
		java 17.0.8 2023-07-18 LTS
		```
1.  Python
	- 이미 설치했다
2.  R
	- R은 잘 알려진 통계 및 그래프 그리기에 특화된 프로그램이다.
	- Centos, Rocky Linux와 같은 RHEL 계열의 패키지 설치 관리자는 기본적으로는 R을 제공하지 않는다.
	- 대신, Powertools라고 하여 개발자 전용 패키지를 추가로 설치하여 주면, R이 포함되어 있다.
	- `yum install epel-release`
	- `yum config-manager --set-enabled crb` 
	- `yum install R`
## GATK가 정상적으로 실행되는지 확인해보자
- gatk가 설치되어 있는 디렉토리에서 gatk를 찾는다.
	- 만약 이 과정이 귀찮다면, gatk를 bash enviroment에 추가하는 방법도 있다. 다만 개인적으로 필수적이거나 설치 과정 중에서 자연스럽게 추가되지 않는 경우에는 지양하는 편이다.
- 나의 경우 `/download/gatk-4.4.0.0` 디렉토리에 gatk가 들어있었다.
- `--list` 를 통하여 GATK를 돌려본다.
	```shell
	# /download/gatk-4.4.0.0/gatk --list
	Using GATK jar /download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar
	Running:
	    java -Dsamjdk.use_async_io_read_samtools=false -Dsamjdk.use_async_io_write_samtools=true -Dsamjdk.use_async_io_write_tribble=false -Dsamjdk.compression_level=2 -jar /download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar --help
	USAGE:  <program name> [-h]
	
	Available Programs:
	...
	```
- 이렇게 프로그램 목록이 쫙 뜨면 성공이다.
# 3. SAMtools 설치
- SAMtools는 BAM/SAM/CRAM 파일을 다루는데 특화되어있다.
- 특히 간단하게 BAM 파일에서 무언가를 확인할 때 좋다.
## SAMtools를 다운받자
https://github.com/samtools/samtools/releases
> *samtools release 1.18
Download the source code here: [samtools-1.18.tar.bz2](https://github.com/samtools/samtools/releases/download/1.18/samtools-1.18.tar.bz2). (The "Source code" downloads are generated by GitHub and are incomplete as they don't bundle HTSlib and are missing some generated files.)*
- 어떤 이유인지 1.18 버전의 경우 링크가 따로 걸려있다.
- `wget` 명령어를 통해 다운받는다.
##  tar.bz2 압축파일을 풀자
- `bz2` 확장자 압축파일을 풀기위해서는 `bzip2` 패키지를 먼저 설치해줘야 한다.
	- `yum install bzip2`
	- 이제 bzip2를 활용하여 압축파일을 해제한다.
		- `bzip2 -d samtools-1.18.tar.bz2`
- `tar` 확장자 압축파일을 풀기 위해서는 `tar` 패키지를 사용한다.
	- 옵션이 굉장히 많은 편인데, 보통 `-xvf` 옵션을 사용한다.    
	  -x : 압축 파일 풀기 (create)    
	  -v : 묶음/해제 과정을 화면에 표시 (verbose)    
	  -f : 파일 이름을 지정 (file)    
	  - `tar -xvf samtools-1.18.tar`
	  - 이제 samtools-1.18 폴더가 생성된다.

## SAMtools를 설치하자
- SAMtools는 GATK와 달리 압축을 풀었어도 바로 사용할 수 없다.
- 압축이 풀린 SAMtools 폴더에 들어가면 굉장히 파일이 많다는 사실을 알 수 있다.
- github에서 clone하는 방식으로 다운로드 받은 경우 `autoheader` 라던가 `autoconf` 라던가 추가적인 패키지가 필요된다. 다행히 단순하게 다운받았기 때문에 이러한 과정은 생략한다.
- 곧바로 SAMtools 폴더 내에서 설치환경 구성을 시도한다.
	- `./configure`
	- 그러면 다음과 같은 에러 메시지를 만나게 된다.
	```shell
	checking for NcursesW wide-character library... no
	checking for Ncurses library... no
	checking for Curses library... no
	configure: error: curses development files not found
	
	The 'samtools tview' command uses the curses text user interface library.
	Building samtools with tview requires curses/ncurses/etc development files
	to be installed on the build machine; you may need to ensure a package such
	as libncurses5-dev (on Debian or Ubuntu Linux) or ncurses-devel (on RPM-based
	Linux distributions) is installed.
	
	FAILED.  Either configure --without-curses or resolve this error to build
	samtools successfully.
	```
	- 위의 메시지를 종합하면 SAMtools의 tview 기능을 사용하기 위해서는 ncurse 패키지를 설치하거나 --without-curses 옵션을 사용하라는 것이다.
	- SAMtools를 설치하는 과정에서 이와 같은 오류 메시지는 4번 정도 발생하게 되므로, 옵션으로 생략하기 보다는 그냥 다 설치하는 편이 낫다.
	- 메시지에서 중요하게 읽어야 하는 부분은 다음의 부분이다:    
	  *"you may need to ensure a package such as libncurses5-dev (on Debian or Ubuntu Linux) or ncurses-devel (on RPM-based Linux distributions) is installed."*
		- 리눅스 시스템 계열에 따라 다른 패키지를 설치해야한다.
		- Rocky Linux의 경우 RPM-based Linux distribution이다.
		- 따라서, `yum install ncurses-devel` 명령어로 ncurse를 설치한 다음, 다시 `./configure` 명령어로 설치환경 구성을 시도해야한다.
	- `ncurse`를 포함하여 총 4번의 패키지 설치 요청이 들어온다.
		- `yum install ncurses-devel`
		- `yum install zlib-devel`
		- `yum install bzip2-devel`
		- `yum install xz-devel`
	- 마지막으로 `make` 명령어를 통해 설치환경 구성을 마친다.
		- `make`
- 이제 진짜로 설치를 한다.
	- `make install`
- SAMtools의 경우 설치가 끝나면 env에 자동으로 명령어가 등록된다. 설치가 잘 되었는지 확인하자.
	```shell
	# samtools --help
	
	Program: samtools (Tools for alignments in the SAM format)
	Version: 1.18 (using htslib 1.18)
	
	Usage:   samtools <command> [options]
	
	Commands:
	...
	```
## 4. 인터넷에서 BAM파일을 받아 variant calling을 시도해보자
- Variant calling을 수행하게 하는 caller의 종류는 여러가지가 있다.
	- DeepVariant
	- GATK의 HaplotypeCaller
	- Vardict 등등....
- 오늘은 GATK의 HaplotypeCaller를 통하여 calling을 시도해보자.
## NCBI에서 받고자 하는 데이터 검색하기
- National Center for Biotechnology Information(NCBI)는 미국 국립보건원에서 운영하고 있는 생물정보학 DB다.
- NCBI의 DB는 여러가지 종류가 있는데, 그중 Sequence Read Archive(SRA)에 sequencing 데이터 모음을 받을 수 있다.
	- SRA에서 BRCA와 관련된 용량이 작은 데이터를 검색해봤다.
		- SRA에서 한번 검색한 다음, SRA run selector로 결과를 보내겠냐는 메시지를 클릭하면 좀 더 편하게 정렬하여 검색이 가능하다.
		- 추천하는 방식으로는 '관심있는 질병의 유전자명'으로 검색한 다음, 필터의 access 항목에 'public'으로 필터를 건 다음에 SRA run selector로 결과를 보내서 용량이 작은 순으로 정렬하여 파일을 받는 것이다. Access type에 대한 필터는 run selector에 없는 것으로 보이기 때문이다.
	- [SRR9929551](https://trace.ncbi.nlm.nih.gov/Traces/index.html?view=run_browser&page_size=10&acc=SRR9929551&display=alignment) 를 선택
	- 그러나 SRA 웹사이트에서 데이터를 바로 받을 수는 없다.
- SRA DB에서 데이터를 받기 위해서는 SRAtoolkit을 설치한 다음, 명령어를 통해 받을 수 있다.  
## NCBI SRA DB에서 데이터를 받기 위해 SRAToolKit 설치하기
[Installing SRA Toolkit](https://github.com/ncbi/sra-tools/wiki/02.-Installing-SRA-Toolkit)
- 툴킷을 Rocky Linux 내로 바로 다운받는다.
	- `wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-centos_linux64.tar.gz`
	- `gzip -d sratoolkit.current-centos_linux64.tar.gz`
	- `tar -xvf sratoolkit.current-centos_linux64.tar`
- 필요한 경우 Github의 설명에 따라 환경변수에 경로를 추가할 수도 있다.
- BAM파일만 받을 생각이기 때문에 여러가지 툴 중에서 `sam-dump` 툴을 활용한다.
	- 받으려는 SRA 데이터의 번호는 `SRR9929551`
	- `sam-dump` 툴은 파일 내용을 그대로 읽어서 출력하기 때문에, 이를 저장해줘야한다.
		- `/download/sratoolkit.3.0.6-centos_linux64/bin/sam-dump SRR9929551 >> SRR9929551.sam`
	- `sam-dump` 이외에 자주 사용되는 명령어로는....    
	  `prefetch`: BAM파일 뿐 아니라 관련된 전체 데이터를 받는다.    
	  `fastq-dump`: fastq파일만 받는다

## SAMtools를 이용하여 SAM 파일을 BAM 파일로 변환하기
- SAMtools의 `view` 기능을 이용하여 BAM 파일로 저장하여준다.
	- `samtools view -b -o SRR9929551.bam SRR992551.sam`
- BAM파일의 index파일도 작성하여 준다.
	- `samtools index SRR9929551.bam -o SRR9929551.bam.bai`

## SAMtools를 이용하여 BAM파일의 reference 파일 확인하고 다운받기
- GATK HaployypeCaller의 경우 두 가지의 input 파일이 필요하다.
	1) BAM 파일
	2) BAM 파일이 만들어질 때 사용된 reference fasta 파일
		- Reference 파일은 index 파일과 dict 파일과 함께 존재해야한다.
- `samtools view --header-only` 옵션을 통하여 reference 파일을 파악하자
	```shell
	# samtools view --header-only SRR9929551.bam | grep "reference"
@PG     ID:tmap CL:mapall -n 12 -f /results/referenceLibrary/tmap-f3/hg19/hg19.fasta -r basecaller_results/IonXpress_016_rawlib.basecaller.bam -v -Y -u --prefix-exclude 5 -o 2 stage1 map4     VN:5.0.7 (517ac65) (201509092132)
	```
- 구글링을 통하여 `tmap`은 torrent mapping의 준말로 iontorrent에서 제공되는 reference 파일로 파악되었다.
- [구글링](https://github.com/domibel/IonTorrent-VariantCaller#get-reference-genome-hg19-from-ion-torrent-size-868170684-828m)을 통하여 reference fasta 파일을 다운로드 받았다.
	- `wget http://ionupdates.com/reference/hg19.zip`
	- `unzip hg19.zip`
- Reference fasta 파일의 index과 dict 파일을 생성하여 HaplotypeCaller를 위한 준비를 한다.
	- `samtools faidx hg19.fasta`
	- `samtools dict hg19.fasta -o hg19.dict`

## HaplotypeCaller 실행하기
```shell
# ./gatk-4.4.0.0/gatk HaplotypeCaller -R hg19.fasta -I SRR9929551.bam -O test.vcf.gz
Using GATK jar /download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar
Running:
    java -Dsamjdk.use_async_io_read_samtools=false -Dsamjdk.use_async_io_write_samtools=true -Dsamjdk.use_async_io_write_tribble=false -Dsamjdk.compression_level=2 -jar /download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar HaplotypeCaller -R hg19.fasta -I SRR9929551.bam -O test.vcf.gz
20:39:42.774 INFO  NativeLibraryLoader - Loading libgkl_compression.so from jar:file:/download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar!/com/intel/gkl/native/libgkl_compression.so
20:39:42.949 INFO  HaplotypeCaller - ------------------------------------------------------------
20:39:42.956 INFO  HaplotypeCaller - The Genome Analysis Toolkit (GATK) v4.4.0.0
20:39:42.956 INFO  HaplotypeCaller - For support and documentation go to https://software.broadinstitute.org/gatk/
20:39:42.956 INFO  HaplotypeCaller - Executing as root@ROCKY on Linux v5.15.90.1-microsoft-standard-WSL2 amd64
20:39:42.957 INFO  HaplotypeCaller - Java runtime: Java HotSpot(TM) 64-Bit Server VM v17.0.8+9-LTS-211
20:39:42.957 INFO  HaplotypeCaller - Start Date/Time: August 3, 2023 at 6:39:42 PM UTC
20:39:42.958 INFO  HaplotypeCaller - ------------------------------------------------------------
20:39:42.958 INFO  HaplotypeCaller - ------------------------------------------------------------
20:39:42.960 INFO  HaplotypeCaller - HTSJDK Version: 3.0.5
20:39:42.961 INFO  HaplotypeCaller - Picard Version: 3.0.0
20:39:42.961 INFO  HaplotypeCaller - Built for Spark Version: 3.3.1
20:39:42.963 INFO  HaplotypeCaller - HTSJDK Defaults.COMPRESSION_LEVEL : 2
20:39:42.964 INFO  HaplotypeCaller - HTSJDK Defaults.USE_ASYNC_IO_READ_FOR_SAMTOOLS : false
20:39:42.965 INFO  HaplotypeCaller - HTSJDK Defaults.USE_ASYNC_IO_WRITE_FOR_SAMTOOLS : true
20:39:42.968 INFO  HaplotypeCaller - HTSJDK Defaults.USE_ASYNC_IO_WRITE_FOR_TRIBBLE : false
20:39:42.968 INFO  HaplotypeCaller - Deflater: IntelDeflater
20:39:42.969 INFO  HaplotypeCaller - Inflater: IntelInflater
20:39:42.969 INFO  HaplotypeCaller - GCS max retries/reopens: 20
20:39:42.969 INFO  HaplotypeCaller - Requester pays: disabled
20:39:42.971 INFO  HaplotypeCaller - Initializing engine
20:39:43.816 INFO  HaplotypeCaller - Done initializing engine
20:39:43.927 INFO  HaplotypeCallerEngine - Disabling physical phasing, which is supported only for reference-model confidence output
20:39:43.993 INFO  NativeLibraryLoader - Loading libgkl_utils.so from jar:file:/download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar!/com/intel/gkl/native/libgkl_utils.so
20:39:44.003 INFO  NativeLibraryLoader - Loading libgkl_pairhmm_omp.so from jar:file:/download/gatk-4.4.0.0/gatk-package-4.4.0.0-local.jar!/com/intel/gkl/native/libgkl_pairhmm_omp.so
20:39:44.096 INFO  IntelPairHmm - Using CPU-supported AVX-512 instructions
20:39:44.097 INFO  IntelPairHmm - Flush-to-zero (FTZ) is enabled when running PairHMM
20:39:44.098 INFO  IntelPairHmm - Available threads: 8
20:39:44.101 INFO  IntelPairHmm - Requested threads: 4
20:39:44.102 INFO  PairHMM - Using the OpenMP multi-threaded AVX-accelerated native PairHMM implementation
20:39:44.264 INFO  ProgressMeter - Starting traversal
20:39:44.266 INFO  ProgressMeter -        Current Locus  Elapsed Minutes     Regions Processed   Regions/Minute
20:39:54.299 INFO  ProgressMeter -        chr1:15651665              0.2                 52180         313080.0
```

ProgressMeter가 뜨면 variant calling이 진행되기 시작한 것이다.